import{R as i,r as k,F as he,j as C,S as ve,L as Ce}from"./index-5d20dca2.js";import{P as u,h as ge,e as Se,L as Ee}from"./Layout-00d27bdb.js";import{u as re}from"./useCartContext-add1cba6.js";import{l as be}from"./stripe.esm-ff582f48.js";import{u as ae}from"./useCustomerContext-963ba732.js";import{u as Pe}from"./useMutation-46fd2380.js";function Q(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(o){return Object.getOwnPropertyDescriptor(n,o).enumerable})),t.push.apply(t,r)}return t}function X(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Q(Object(t),!0).forEach(function(r){oe(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Q(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}function B(n){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?B=function(e){return typeof e}:B=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},B(n)}function oe(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function F(n,e){return xe(n)||je(n,e)||ke(n,e)||Oe()}function xe(n){if(Array.isArray(n))return n}function je(n,e){var t=n&&(typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"]);if(t!=null){var r=[],o=!0,a=!1,c,l;try{for(t=t.call(n);!(o=(c=t.next()).done)&&(r.push(c.value),!(e&&r.length===e));o=!0);}catch(s){a=!0,l=s}finally{try{!o&&t.return!=null&&t.return()}finally{if(a)throw l}}return r}}function ke(n,e){if(n){if(typeof n=="string")return Z(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);if(t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set")return Array.from(n);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Z(n,e)}}function Z(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}function Oe(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var Y=function(e){var t=i.useRef(e);return i.useEffect(function(){t.current=e},[e]),t.current},R=function(e){return e!==null&&B(e)==="object"},Re=function(e){return R(e)&&typeof e.then=="function"},we=function(e){return R(e)&&typeof e.elements=="function"&&typeof e.createToken=="function"&&typeof e.createPaymentMethod=="function"&&typeof e.confirmCardPayment=="function"},ee="[object Object]",Ae=function n(e,t){if(!R(e)||!R(t))return e===t;var r=Array.isArray(e),o=Array.isArray(t);if(r!==o)return!1;var a=Object.prototype.toString.call(e)===ee,c=Object.prototype.toString.call(t)===ee;if(a!==c)return!1;if(!a&&!r)return e===t;var l=Object.keys(e),s=Object.keys(t);if(l.length!==s.length)return!1;for(var d={},f=0;f<l.length;f+=1)d[l[f]]=!0;for(var S=0;S<s.length;S+=1)d[s[S]]=!0;var b=Object.keys(d);if(b.length!==l.length)return!1;var w=e,A=t,P=function(O){return n(w[O],A[O])};return b.every(P)},se=function(e,t,r){return R(e)?Object.keys(e).reduce(function(o,a){var c=!R(t)||!Ae(e[a],t[a]);return r.includes(a)?(c&&console.warn("Unsupported prop change: options.".concat(a," is not a mutable property.")),o):c?X(X({},o||{}),{},oe({},a,e[a])):o},null):null},Le="Invalid prop `stripe` supplied to `Elements`. We recommend using the `loadStripe` utility from `@stripe/stripe-js`. See https://stripe.com/docs/stripe-js/react#elements-props-stripe for details.",te=function(e){if(e===null||we(e))return e;throw new Error(Le)},Ne=function(e){if(Re(e))return{tag:"async",stripePromise:Promise.resolve(e).then(te)};var t=te(e);return t===null?{tag:"empty"}:{tag:"sync",stripe:t}},K=i.createContext(null);K.displayName="ElementsContext";var Ie=function(e,t){if(!e)throw new Error("Could not find Elements context; You need to wrap the part of your app that ".concat(t," in an <Elements> provider."));return e},H=i.createContext(null);H.displayName="CartElementContext";var _e=function(e,t){if(!e)throw new Error("Could not find Elements context; You need to wrap the part of your app that ".concat(t," in an <Elements> provider."));return e},ce=function(e){var t=e.stripe,r=e.options,o=e.children,a=i.useMemo(function(){return Ne(t)},[t]),c=i.useState(null),l=F(c,2),s=l[0],d=l[1],f=i.useState(null),S=F(f,2),b=S[0],w=S[1],A=i.useState(function(){return{stripe:a.tag==="sync"?a.stripe:null,elements:a.tag==="sync"?a.stripe.elements(r):null}}),P=F(A,2),g=P[0],O=P[1];i.useEffect(function(){var E=!0,I=function(_){O(function(T){return T.stripe?T:{stripe:_,elements:_.elements(r)}})};return a.tag==="async"&&!g.stripe?a.stripePromise.then(function(x){x&&E&&I(x)}):a.tag==="sync"&&!g.stripe&&I(a.stripe),function(){E=!1}},[a,g,r]);var L=Y(t);i.useEffect(function(){L!==null&&L!==t&&console.warn("Unsupported prop change on Elements: You cannot change the `stripe` prop after setting it.")},[L,t]);var N=Y(r);return i.useEffect(function(){if(g.elements){var E=se(r,N,["clientSecret","fonts"]);E&&g.elements.update(E)}},[r,N,g.elements]),i.useEffect(function(){var E=g.stripe;!E||!E._registerWrapper||!E.registerAppInfo||(E._registerWrapper({name:"react-stripe-js",version:"2.1.0"}),E.registerAppInfo({name:"react-stripe-js",version:"2.1.0",url:"https://stripe.com/docs/stripe-js/react"}))},[g.stripe]),i.createElement(K.Provider,{value:g},i.createElement(H.Provider,{value:{cart:s,setCart:d,cartState:b,setCartState:w}},o))};ce.propTypes={stripe:u.any,options:u.object};var D=function(e){var t=i.useContext(K);return Ie(t,e)},ne=function(e){var t=i.useContext(H);return _e(t,e)},Te=function(){var e=D("calls useElements()"),t=e.elements;return t},Ue=function(){var e=D("calls useStripe()"),t=e.stripe;return t};u.func.isRequired;var v=function(e,t,r){var o=!!r,a=i.useRef(r);i.useEffect(function(){a.current=r},[r]),i.useEffect(function(){if(!o||!e)return function(){};var c=function(){a.current&&a.current.apply(a,arguments)};return e.on(t,c),function(){e.off(t,c)}},[o,t,e,a])},Be=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},p=function(e,t){var r="".concat(Be(e),"Element"),o=function(s){var d=s.id,f=s.className,S=s.options,b=S===void 0?{}:S,w=s.onBlur,A=s.onFocus,P=s.onReady,g=s.onChange,O=s.onEscape,L=s.onClick,N=s.onLoadError,E=s.onLoaderStart,I=s.onNetworksChange,x=s.onCheckout,_=s.onLineItemClick,T=s.onConfirm,ie=s.onCancel,ue=s.onShippingAddressChange,le=s.onShippingRateChange,fe=D("mounts <".concat(r,">")),M=fe.elements,pe=i.useState(null),z=F(pe,2),y=z[0],me=z[1],j=i.useRef(null),W=i.useRef(null),J=ne("mounts <".concat(r,">")),$=J.setCart,q=J.setCartState;v(y,"blur",w),v(y,"focus",A),v(y,"escape",O),v(y,"click",L),v(y,"loaderror",N),v(y,"loaderstart",E),v(y,"networkschange",I),v(y,"lineitemclick",_),v(y,"confirm",T),v(y,"cancel",ie),v(y,"shippingaddresschange",ue),v(y,"shippingratechange",le);var U;e==="cart"?U=function(G){q(G),P&&P(G)}:P&&(e==="expressCheckout"?U=P:U=function(){P(y)}),v(y,"ready",U);var de=e==="cart"?function(h){q(h),g&&g(h)}:g;v(y,"change",de);var ye=e==="cart"?function(h){q(h),x&&x(h)}:x;v(y,"checkout",ye),i.useLayoutEffect(function(){if(j.current===null&&M&&W.current!==null){var h=M.create(e,b);e==="cart"&&$&&$(h),j.current=h,me(h),h.mount(W.current)}},[M,b,$]);var V=Y(b);return i.useEffect(function(){if(j.current){var h=se(b,V,["paymentRequest"]);h&&j.current.update(h)}},[b,V]),i.useLayoutEffect(function(){return function(){j.current&&(j.current.destroy(),j.current=null)}},[]),i.createElement("div",{id:d,className:f,ref:W})},a=function(s){D("mounts <".concat(r,">")),ne("mounts <".concat(r,">"));var d=s.id,f=s.className;return i.createElement("div",{id:d,className:f})},c=t?a:o;return c.propTypes={id:u.string,className:u.string,onChange:u.func,onBlur:u.func,onFocus:u.func,onReady:u.func,onEscape:u.func,onClick:u.func,onLoadError:u.func,onLoaderStart:u.func,onNetworksChange:u.func,onCheckout:u.func,onLineItemClick:u.func,onConfirm:u.func,onCancel:u.func,onShippingAddressChange:u.func,onShippingRateChange:u.func,options:u.object},c.displayName=r,c.__elementType=e,c},m=typeof window>"u";p("auBankAccount",m);p("card",m);p("cardNumber",m);p("cardExpiry",m);p("cardCvc",m);p("fpxBank",m);p("iban",m);p("idealBank",m);p("p24Bank",m);p("epsBank",m);var Fe=p("payment",m);p("expressCheckout",m);p("paymentRequestButton",m);p("linkAuthentication",m);p("address",m);p("shippingAddress",m);p("cart",m);p("paymentMethodMessaging",m);p("affirmMessage",m);p("afterpayClearpayMessage",m);const De=({stripe:n,elements:e,clientSecret:t})=>{const[r,o]=k.useState(null),[a,c]=k.useState(!1),{customer:l}=ae();return k.useEffect(()=>{if(!n||!t)return;(async()=>{c(!0);try{switch((await n.retrievePaymentIntent(t)).paymentIntent.status){case"succeeded":o("Payment succeeded!");break;case"processing":o("Your payment is processing.");break;case"requires_payment_method":o("Your payment was not successful, please try again.");break;default:o("Something went wrong.");break}}catch(f){console.error("Error retrieving payment intent:",f),o("Something went wrong.")}finally{return c(!1),r}})()},[n,t]),{paymentLoading:a,handlePayment:async d=>{if(d==null||d.preventDefault(),!(!n||!e||!t)){c(!0);try{const f=await n.confirmPayment({confirmParams:{return_url:`${he}payment-success/`,receipt_email:l.email},elements:e});f.error?(o(f.error.message||"Something went wrong."),console.error("Payment error:",f.error)):(o("Payment successfully processed. Redirecting..."),console.log("Payment succeeded:",f))}catch(f){console.error("Error processing payment:",f),o("Something went wrong.")}finally{c(!1),console.log("Payment complete.")}}}}},Me=({totalAmount:n,clientSecret:e})=>{const t=Ue(),r=Te(),{handlePayment:o,paymentLoading:a}=De({stripe:t,elements:r,clientSecret:e});return C.jsxs("form",{id:"payment-form",className:"stripe",onSubmit:c=>o(c),children:[C.jsx(ge,{headingText:"Primal Formulas Checkout"}),C.jsx(Fe,{id:"payment-element"}),C.jsx("button",{disabled:!t||!r,id:"submit",children:a?C.jsx("div",{className:"spinner",id:"spinner"}):C.jsxs("span",{id:"button-text",children:["Pay now - â‚¬",n.toFixed(2)]})})]})},We=()=>{const n=re(),{customer:e}=ae(),[t,r]=k.useState(!1),a=Pe(async()=>{if(n.cart.length===0)return null;const d={cart:n.cart.map(S=>({price:S.price,quantity:S.quantity})),customer:{name:e.name,address:{...e.address}},receipt_email:e.email};return(await Se({endpoint:"create-payment-intent",method:"POST",data:JSON.stringify(d)})).client_secret},{onSuccess:()=>{r(!0)}});k.useEffect(()=>{!t&&n.cart.length>0&&e!==null&&!a.isLoading&&a.mutate()},[t,n.cart,e]);const c={theme:"night",variables:{colorPrimary:"#b59410",colorBackground:"#2f2f2f"}};return{options:a.data?{clientSecret:a.data,appearance:c}:{},clientSecret:a.data,isFetchingClientSecret:a.isLoading,error:a.error}},$e=be(ve),qe=()=>{const{cart:n,calculateTotalAmount:e}=re(),t=e(n),{options:r,clientSecret:o,error:a,isFetchingClientSecret:c}=We(),[l,s]=k.useState(o);return k.useEffect(()=>{o&&!l&&s(o)},[o]),c?C.jsx("div",{className:"stripe-form",children:C.jsx(Ce,{})}):a?C.jsxs("div",{className:"stripe-form",children:["Error: ",a.message]}):C.jsx("div",{className:"stripe-form",children:l&&C.jsx(ce,{options:r,stripe:$e,children:C.jsx(Me,{clientSecret:l,totalAmount:t})})})},Ge=()=>C.jsx(Ee,{children:C.jsx("section",{id:"checkout",children:C.jsx(qe,{})})});export{Ge as Checkout,Ge as default};
